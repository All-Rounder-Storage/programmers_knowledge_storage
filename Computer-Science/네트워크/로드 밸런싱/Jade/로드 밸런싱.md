# 로드 밸런싱

## 로드 밸런싱이란?

- 로드밸런싱은 여러 대의 서버를 두고 서비스를 제공하게 될 때 부하 분산을 위하여 사용하게 되는 기술이다.
- 로드밸런싱은 `클라이언트`와 여러 대의 서버로 이루어진 `서버 그룹` 사이에 위치한 `로드 밸런서` 에 의해 이루어진다.

  [loadBalancer]

- 클라이언트에서 많은 요청이 들어왔을 때 한대의 서버에게만 부하가 가해지지 않도록 트래픽을 관리해 서버가 최적의 퍼포먼스를 낼 수 있게 해준다.
  
<br />

## 로드 밸런싱은 언제 필요할까?


- 로드 밸런싱에 대해 더 얘기해보기전에 로드 밸런싱이 나오게 된 배경에 대해 생각해보면 이해가 더 쉬울 것이다.

<br />

`자, 인터넷상에 어떤 서비스를 하나 운영하고 있다고 가정해보자`

- 분명 서비스 제공 초기 단계에서는 사용자들의 수가 적을 것이고, 사용자 수가 적기 때문에 클라이언트에서 서버로 보내는 요청의 수도 적을 것이다.

<br />

#### 하지만 서비스가 대박이 나게됐고 대박 소문을 듣고 서비스를 찾는 사용자 수가 커지게 된다면?

```
이때 해결책으로 나오게 되는 방법이 바로 **Scale-up**과 **Scale-out** 이라는 개념이다.
```

- 아마 기존 서버 하나로는 요청에 대한 모든 응대가 불가능 할것이다.
- `이때 가장 먼저 생각하게 되는 방법은 서버 한개의 성능을 확장 하는 것이다.`
    - 이것이 바로 **Scale-up 이다.**
    - CPU의 성능을 높이는 것을 이에 대한 예시로 들 수 있다.

  [scale-up]

  [이미지 출처](https://blog.router-switch.com/2021/03/what-is-the-difference-between-scale-up-and-scale-out/)

<br />

#### 하지만 서비스가 초대박이 나서 사용자가 기하급수적으로 더더더 늘어나게 된다면???

- 아마 하나의 서버에 성능을 확장하는데 있어서는 분명 기술적인 한계가 존재할 것이다.
- 그렇담 그 다음으로 생각할 수 있는 방법은?
    - `하나만 사용하던 서버를 여러대의 서버로 늘리는 것이다.`
    - 이것이 바로 **Scale-out 이다.**

  [scale-out]

  [이미지 출처](https://blog.router-switch.com/2021/03/what-is-the-difference-between-scale-up-and-scale-out/)

<br />

#### 하지만 그냥 서버만 여러대를 늘리게 된다면 한계점이 존재한다.

- 예를들어, A 서버 한개만 있던것에 B, C 서버를 추가했다고 하자
    - 그런데 만약 A 서버에서 받은 요청이 다른 B, C 서버들 보다 훨씬 오래 걸리는 작업이라면?
        - A 서버는 B, C 서버보다 많은 양의 부하를 받게되고 프로세스가 느려지게 되며 이는 서버가 한개일 때와 상황이 똑같아 진다.
    - 만약에 B 서버가 갑자기 통신이 되지 않는 상황이라면?
        - 서버들 사이에는 무슨일을 하고 있는지 모르던 상황이기 때문에 통신이 되지 않는 B 서버가 하던 작업은 간과된다.
    - 만약에 A, B는 할줄 모르는 작업이지만 C 서버는 그 작업에 특화 돼있다면?

- 이러한 한계점을 극복하기 위해서는 A, B, C 서버들을 모니터하고 서버들 사이에 트래픽을 분배해주는 `로드 밸런서가 필요하고 로드 밸런싱이 필요한 것이다.`
- 로드 밸런서는 각각의 서버가 최적의 퍼포먼스를 내고 프로세스 처리를 빠르게 만들기 위해서 각 서버들의 상황을 고려하여 트래픽을 분배 해준다.
- 이러한 트래픽을 분배해주는 방법 (로드밸런싱 알고리즘)에도 여러가지가 존재한다.

<br />

### 로드 밸런싱 알고리즘

---

1. **라운드 로빈** **(Round Robin)**
  - `요청이 들어오는 순서대로 돌아가며 배정`하는 방식이다.
  - 순서대로 배정되기 때문에 `같은 스펙의 서버 여러대가 있을 경우`에 사용하기 좋다.
  - 만약에 스펙 차이가 있는 서버가 있는 경우에도, 좋은 성능을 가진 서버인것과는 별개로 요청이 들어온 순서대로 배정되기 때문에 좋은 성능이 다 사용 되지 않고 낭비 될 수 있다.
  - 서버와의 `연결(세션)이 오래 지속되지 않는 경우` 에 활용하기 적합하다.

2. **가중 라운드 로빈** **(Weighted Round Robin Method)**
  - 기본적으로 라운드 로빈과 같이 동작하나 서버의 스펙이 다른 경우를 생각해볼 수 있다.
  - 서버의 스펙이 다르기 때문에 스펙에 따라 각각의 서버에 `가중치(Weight)`를 매기고 `가중치가 높은 서버에 클라이언트 요청을 우선적으로 배분한다.`
  - 주로 `서버의 트래픽 처리 능력이 상이한 경우` 사용된다.
    - 즉, 로드밸런싱 방식으로 가중치가 높은 서버는 더 많은 트래픽을 갖게되고 가중치가 낮은 서버는 더 적은 트래픽을 갖게된다.
    - 예를들어 **서버 A의 가중치가 3이고 서버 B의 가중치가 2라면**
    - A 서버는 3개의 트래픽이 할당되고, B 서버에는 2개의 트래픽이 할당된다.

3. **최소 연결 방식** **(Least Connection Method)**
  - 요청이 들어온 시점에 `가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배분`한다.
  - 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합한 방식이다.

4. **최소 리스폰타임** **(Least Response Time Method)**
  - `서버의 현재 연결 상태와 응답시간을 모두 고려`하여 트래픽을 배분한다.
    - 응답시간 : 서버에 요청을 보내고 최초 응답을 받을 때까지 소요되는 시간
  - 연결 상태와 응답시간을 모두 고려하기 때문에 가장 적은 연결을 하고 있고, 응답속도도 가장 빠른 서버에 우선적으로 연결하는 방식이다.

5. **대역폭 방식 (Bandwidth Method)**
  - 서버들의 `대역폭을 고려하여` 서버에 트래픽을 할당하는 방식이다.

6. **IP 해시 방식** **(IP Hash Method)**
  - `클라이언트의 IP 주소를 특정 서버로 매핑 하는 방식`이다.
  - 클라이언트의 IP 를 해싱 해서 서버를 지정하기 때문에 사용자가 `항상 동일한 서버로 연결`된다.
    - 해싱은 임의의 길이를 지닌 데이터를 고정된 길이의 데이터로 매핑 하는 것을 의미한다.
    - 예를들어, A 지역에서 들어온 아이피같은 경우 A 서버로, B 지역에서 들어온 경우 B 서버로 보내는 방식이라고 보면된다.

<br />

#### 그렇다면 이런 로드 밸런싱 알고리즘을 이용하는 로드 밸런서의 종류에는 무엇이 있을까?

<br />

### 로드 밸런싱의 종류

---

- 로드 밸런싱의 종류는 [OSI 7 계층](https://github.com/dbwjd5864/programmers_knowledge_storage/blob/main/Computer-Science/네트워크/OSI%207%20layer/Jade/OSI%207%20layer.md#osi-7-계층)에 따라 나뉘게 되는데 각각의 계층, L1, L2, L3, ... L7 이 이에 해당한다.
- 하지만 로드 밸런싱에는 OSI 7 계층 중에서 [4계층](https://github.com/dbwjd5864/programmers_knowledge_storage/blob/main/Computer-Science/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/OSI%207%20layer/Jade/OSI%207%20layer.md#4-%EC%A0%84%EC%86%A1-%EA%B3%84%EC%B8%B5transport-layer), L4 로드 밸런서와 [7계층](https://github.com/dbwjd5864/programmers_knowledge_storage/blob/main/Computer-Science/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC/OSI%207%20layer/Jade/OSI%207%20layer.md#7-%EC%9D%91%EC%9A%A9-%EA%B3%84%EC%B8%B5application-layer), L7 로드 밸런서가 가장 많이 활용된다.
  - 그러한 이유는 **L4 로드 밸런서 부터** `포트 정보를 바탕으로 트래픽을 분산` 가능하기 때문이다. 한 대의 서버에 각기 다른 포트 번호를 부여하여 다수의 서버 프로그램을 운영하는 경우라면 최소 L4 로드밸런서 이상을 사용해야만 한다.

<br />

💡 L4 로드 밸런서와 L7 로드 밸런서를 이용하면 각각의 장, 단점이 존재하기 때문에 두개를 비교해보자

<br />

#### L4 로드 밸런서 VS L7 로드 밸런서

[l4]

[l7]

|  | L4 로드 밸런서                                                                                                                                 | L7 로드 밸런서                                                                                                                                                   |
| --- |-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 네트워크 계층 | 4계층 전송 계층 (Transport Layer)                                                                                                               | 7계층 응용 계층 (Application Layer)                                                                                                                               |
| 특징 | 네트워크 계층 (IP, IPX) 이나 트랜스포트 계층 (TCP, UDP) 의 정보를 바탕으로 트래픽을 분산한다.                                                                            | TCP / UDP 정보 뿐만 아니라 HTTP 헤더, 쿠키 등과 같은 사용자의 요청을 기준으로 특정 서버에 트래픽을 분산한다.                                                                                       |
| 장점 | - 데이터를 들여다 보지 않고 패킷 레벨에서만 트래픽 분산을 하기 때문에 속도가 빠르고 효율이 높다. <br /> - 데이터를 들여다 보지 않기 때문에 데이터 복호화 과정이 필요없으므로 더 안전한다. <br /> - L7 로드 밸런서보다 저렴하다. | - 상위 계층에서 트래픽을 분산하기 때문에 더 섬세한 라우팅이 가능하다. <br /> - 캐싱 기능을 제공한다. <br /> - 특정한 패턴을 지닌 바이러스를 감지해 네트워크를 보호할 수 있으며, DoS/DDoS와 같은 비정상적 트래픽을 필터링할 수 있어 서비스 안정성이 높다. |
| 단점 | - 데이터를 들여다 볼 수 없기 때문에 섬세한 라우팅은 불가능하다. <br /> - 사용자의 IP가 수시로 바뀐다면 연속적인 서비스를 제공하기 힘들어진다.                                                    | - 데이터 복호화 과정이 필요하기 때문에 더 높은 비용을 지불해야 한다. <br /> - 클라이언트가 로드 밸런서와 인증서를 공유해야하기 때문에 보안 상의 위험성이 존재한다.                                                           |

<br />

#### 지금까지 로드 밸런서란 무엇이며 로드 밸런싱은 무엇인지 비교해 보았는데 글을 끝내기에 앞서 한가지만 더 이야기해보려 한다.

- 만약에 저런 중요한 역할을 하는 로드 밸런서가 죽으면 어떻게 될까?
- `로드 밸런서가 죽으면 사실상 서비스도 죽는다.`
- 이렇듯 특정한 지점에서 Failure가 났을 때 전체 시스템이 다운되는 경우를 `Single Point of Failure(SPOF)`  라고 부른다.
- 그렇기 때문에 `로드 밸런서 자체도 Scale-out이 필요`하다.
  - 예를들어, Master-Slave 방식을 구축하여 마스터가 항상 일을 하되, 마스터가 예상치 못한 이유로 죽어버리는 경우에 Slave를 마스터로 바로 임명시켜서 서비스를 이어나갈 수 있게 하는 것이다!

<br />

### Reference

---

- [로드 밸런싱이란? 천상계 개발자가 되려면 이 정도는 알아야지](https://www.youtube.com/watch?v=9_6COPOMZvI)
- [로드밸런서 (Load Balancer)의 개념과 특징](https://m.post.naver.com/viewer/postView.naver?volumeNo=27046347&memberNo=2521903)
- [Load Balancers, An Analogy](https://codeburst.io/load-balancers-an-analogy-cc64d9430db0)